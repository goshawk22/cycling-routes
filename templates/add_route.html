{% extends "base.html" %}
{% block title %}Upload Route{% endblock %}

{% block content %}
  <div class="max-w-lg mx-auto mt-10 bg-white border border-gray-200 rounded-xl shadow p-8">
    <h1 class="text-2xl font-bold mb-6">Upload a Cycling Route</h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-4">
          {% for message in messages %}
            <div class="bg-red-100 border border-red-300 text-red-700 px-4 py-2 rounded mb-2">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data" class="flex flex-col gap-4">
      <div>
        <label for="name" class="block font-medium mb-1">Route Name</label>
        <input type="text" name="name" id="name" required
          class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
      <div>
        <label for="description" class="block font-medium mb-1">Description</label>
        <textarea name="description" id="description" rows="4" required
          class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
      </div>
      <div>
        <label for="tags" class="block font-medium mb-1">Tags (comma-separated)</label>
        <input type="text" name="tags" id="tags" placeholder="e.g. gravel, loop, intervals"
          class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" name="offroad" id="offroad" value="1"
          class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
        <label for="offroad" class="font-medium">This route includes offroad sections</label>
      </div>
      
      <!-- Cafe addition section -->
      <div class="border-t pt-4 mt-4">
        <div class="flex items-center gap-2 mb-4">
          <input type="checkbox" name="add_cafe" id="add_cafe" value="1"
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
          <label for="add_cafe" class="font-medium">Add a cafe along this route</label>
        </div>
        
        <div id="cafe-fields" class="hidden space-y-4">
          <div>
            <label for="cafe_name" class="block font-medium mb-1">Cafe Name</label>
            <input type="text" name="cafe_name" id="cafe_name"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
          
          <div>
            <label for="cafe_address_search" class="block font-medium mb-1">Address or Location</label>
            <div class="flex gap-2">
              <input type="text" id="cafe_address_search" 
                placeholder="Search for address or place name..."
                class="flex-1 rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
              <button type="button" id="cafe_search_btn" 
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                Search
              </button>
            </div>
            <p class="text-sm text-gray-600 mt-1">E.g. try searching for "The Garden Shed Cafe" or enter the address</p>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="cafe_latitude" class="block font-medium mb-1">Latitude</label>
              <input type="number" step="any" name="cafe_latitude" id="cafe_latitude"
                placeholder="e.g. 52.3813"
                class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label for="cafe_longitude" class="block font-medium mb-1">Longitude</label>
              <input type="number" step="any" name="cafe_longitude" id="cafe_longitude"
                placeholder="e.g. -1.5616"
                class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
          </div>
          <p class="text-sm text-gray-500">Coordinates will be filled automatically when you search above, or you can enter them manually.</p>
          
          <div>
            <label for="cafe_description" class="block font-medium mb-1">Cafe Description</label>
            <textarea name="cafe_description" id="cafe_description" rows="2"
              placeholder="Brief description..."
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
          </div>
          
          <div>
            <label for="cafe_website" class="block font-medium mb-1">Website (optional)</label>
            <input type="url" name="cafe_website" id="cafe_website" 
              placeholder="https://example.com"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
        </div>
      </div>
      <div>
        <label for="gpx_file" class="block font-medium mb-1">GPX File</label>
        <input type="file" name="gpx_file" id="gpx_file" accept=".gpx" required
          class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
        <p class="text-sm text-gray-500 mt-2">Please only upload routes that start near campus or Leamington.</p>
      </div>
      <button type="submit"
        class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition">Upload Route</button>
    </form>
    <a href="/" class="inline-block mt-6 text-blue-600 hover:underline text-sm">‚Üê Back to route list</a>
  </div>
  {% endblock %}

  {% block scripts %}
  <script>
  document.querySelector('form').addEventListener('submit', function(e) {
      const fileInput = document.getElementById('gpx_file');
      if (fileInput.files.length && fileInput.files[0].size > 5 * 1024 * 1024) {
          alert("File is too large (max 5MB).");
          e.preventDefault();
      }
  });

  // Handle cafe checkbox
  document.getElementById('add_cafe').addEventListener('change', function() {
      const cafeFields = document.getElementById('cafe-fields');
      if (this.checked) {
          cafeFields.classList.remove('hidden');
      } else {
          cafeFields.classList.add('hidden');
      }
  });

  // Cafe address search functionality
  document.getElementById('cafe_search_btn').addEventListener('click', searchCafeAddress);
  document.getElementById('cafe_address_search').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
          e.preventDefault();
          searchCafeAddress();
      }
  });

  async function searchCafeAddress() {
      const query = document.getElementById('cafe_address_search').value.trim();
      if (!query) {
          alert('Please enter an address or location to search');
          return;
      }

      const searchBtn = document.getElementById('cafe_search_btn');
      searchBtn.textContent = 'Searching...';
      searchBtn.disabled = true;

      try {
          // Use Nominatim (OpenStreetMap) geocoding service
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=gb&bounded=1&viewbox=-2.5,53.5,-0.5,51.5`);
          const results = await response.json();

          if (results && results.length > 0) {
              // If multiple results, show them to user
              if (results.length > 1) {
                  const options = results.map((result, index) => 
                      `${index + 1}. ${result.display_name}`
                  ).join('\n');
                  
                  const choice = prompt(`Multiple locations found. Enter the number of your choice:\n\n${options}`);
                  const choiceIndex = parseInt(choice) - 1;
                  
                  if (choiceIndex >= 0 && choiceIndex < results.length) {
                      setCafeLocationFromResult(results[choiceIndex]);
                  } else {
                      // Use first result if invalid choice
                      setCafeLocationFromResult(results[0]);
                  }
              } else {
                  setCafeLocationFromResult(results[0]);
              }
          } else {
              alert('No locations found. Please try a different search term or enter coordinates manually.');
          }
      } catch (error) {
          console.error('Search error:', error);
          alert('Search failed. Please try again or enter coordinates manually.');
      } finally {
          searchBtn.textContent = 'Search';
          searchBtn.disabled = false;
      }
  }

  function setCafeLocationFromResult(result) {
      const lat = parseFloat(result.lat);
      const lon = parseFloat(result.lon);
      
      document.getElementById('cafe_latitude').value = lat.toFixed(6);
      document.getElementById('cafe_longitude').value = lon.toFixed(6);
      
      // Show success message
      const locationName = result.display_name.split(',')[0];
      alert(`Location found: ${locationName}`);
  }
  </script>
  {% endblock %}
